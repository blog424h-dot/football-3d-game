لعبة كرة القدم 3D — الكود الكامل (HTML)
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لعبة كرة القدم 3D الكاملة</title>
<style>
  /* --- ستايلات الواجهة --- */
  html,body{height:100%;margin:0;background:#071217;font-family:Arial,Helvetica,sans-serif;overflow:hidden;}
  canvas{display:block;}
  #ui{position:fixed;inset:0;pointer-events:none;z-index:50;}
  .panel{pointer-events:auto;background:rgba(0,0,0,0.75);color:#fff;padding:14px;border-radius:10px;max-width:92%;max-height:92%;overflow:auto;}
  #menu,#teamSelection,#formationPanel,#settingsPanel,#pausePanel,#messages{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);display:none;z-index:60;}
  #topHud{position:fixed;left:10px;top:10px;color:#fff;z-index:55;font-weight:600;}
  #score{font-size:18px;margin-bottom:6px;}
  #timeDisplay{font-size:16px;}
  button,select,input{font-size:14px;padding:8px;margin:6px;border-radius:6px;}
  #mobileControls{position:fixed;bottom:18px;left:18px;z-index:55;display:flex;gap:8px;}
  .mbtn{width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:#fff;display:flex;align-items:center;justify-content:center;pointer-events:auto;}
  #jumpBtn{position:fixed;right:18px;bottom:24px;width:70px;height:70px;border-radius:50%;pointer-events:auto;}
  #messages{left:50%;top:10%;transform:translate(-50%,0);padding:10px 18px;background:rgba(0,0,0,0.6);border-radius:8px;}
  .card{display:inline-block;padding:6px 10px;border-radius:6px;margin:4px;background:#222;color:#fff;font-weight:700;}
</style>
</head>
<body>
<div id="ui">
  <div id="topHud" style="pointer-events:auto">
    <div id="score">النتيجة: <span id="scoreA">0</span> — <span id="scoreB">0</span></div>
    <div id="timeDisplay">الوقت: <span id="matchTime">0:00</span></div>
    <div id="controlsHint">اضغط ESC للقائمة — أسهم/WASD أو أزرار الموبايل للحركة — Space للقفز</div>
  </div>

  <div id="menu" class="panel">
    <h3>اختر نوع المباراة</h3>
    <select id="competitionSelect">
      <option value="friendly">مباراة ودية</option>
      <option value="spanish">الدوري الإسباني</option>
      <option value="english">الدوري الإنجليزي</option>
      <option value="german">الدوري الألماني</option>
      <option value="french">الدوري الفرنسي</option>
      <option value="italian">الدوري الإيطالي</option>
      <option value="ucl">دوري أبطال أوروبا</option>
      <option value="africa">كأس أمم إفريقيا</option>
      <option value="euro">كأس أمم أوروبا</option>
      <option value="world">كأس العالم</option>
    </select>
    <div><button id="nextToTeams">التالي</button></div>
  </div>

  <div id="teamSelection" class="panel">
    <h3>اختر فريقك</h3>
    <select id="teamSelect"></select>
    <div><button id="confirmTeam">التالي</button></div>
  </div>

  <div id="formationPanel" class="panel">
    <h3>التشكيلة الأساسية (يمكن استبدال حتى 5 لاعبين)</h3>
    <div id="playersContainer" style="display:flex;flex-direction:column;gap:6px;"></div>
    <div><button id="confirmFormation">تأكيد التشكيلة</button></div>
  </div>

  <div id="settingsPanel" class="panel">
    <h3>إعدادات المباراة</h3>
    <label>مدة المباراة (دقائق):</label>
    <select id="durationSelect">
      <option>5</option><option>10</option><option>15</option><option>20</option><option>25</option><option selected>30</option>
    </select><br>
    <label>وقت اضافي عند الحاجة:</label>
    <select id="extraSelect"><option>0</option><option>3</option><option>5</option></select><br>
    <label>الملعب:</label>
    <select id="stadiumSelect"><option value="default">الملعب الافتراضي</option><option value="stad1">الملعب 1</option></select><br>
    <label>الطقس:</label>
    <select id="weatherSelect"><option value="sunny">مشمس</option><option value="cloudy">غائم</option><option value="rainy">ممطر</option></select><br>
    <label>النهار/الليل:</label>
    <select id="timeOfDay"><option value="day">نهار</option><option value="night">ليل</option></select><br>
    <div><button id="startGameBtn">ابدأ المباراة</button></div>
  </div>

  <div id="pausePanel" class="panel">
    <h3>قائمة التوقف</h3>
    <div><button id="resumeBtn">استئناف</button>
    <button id="cameraBtn">إعدادات الكاميرا</button>
    <button id="editFormBtn">تعديل التشكيلة</button>
    <button id="exitBtn">خروج</button></div>
  </div>

  <div id="messages" class="panel" style="display:none"></div>

  <div id="mobileControls" style="display:none">
    <div class="mbtn" data-key="arrowleft">◀</div>
    <div class="mbtn" data-key="arrowup">▲</div>
    <div class="mbtn" data-key="arrowdown">▼</div>
    <div class="mbtn" data-key="arrowright">▶</div>
  </div>
  <div id="jumpBtn" class="mbtn" style="display:none" data-key=" ">⭡</div>
</div>

<!-- ثلاثية الأبعاد (Three.js) -->
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

/* ---------------------------
   متغيرات المشهد والـ UI
--------------------------- */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 500);
camera.position.set(0,18,32);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* إضاءة متغيرة حسب النهار/الليل */
const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
scene.add(hemi);
const sun = new THREE.DirectionalLight(0xffffff, 1.0);
sun.position.set(-12,22,8); sun.castShadow = true;
scene.add(sun);

/* الملعب */
const FIELD_W = 40, FIELD_H = 24;
const grass = new THREE.Mesh(new THREE.PlaneGeometry(FIELD_W+6, FIELD_H+6), new THREE.MeshStandardMaterial({color:0x0e7a2f, roughness:1}));
grass.rotation.x = -Math.PI/2; grass.receiveShadow = true; scene.add(grass);

/* خطوط الملعب */
function addLine(w,h,x,z){
  const m = new THREE.Mesh(new THREE.PlaneGeometry(w,h), new THREE.MeshBasicMaterial({color:0xffffff}));
  m.rotation.x = -Math.PI/2; m.position.set(x,0.02,z);
  scene.add(m);
}
addLine(FIELD_W,0.12,0,-FIELD_H/2); addLine(FIELD_W,0.12,0,FIELD_H/2);
addLine(0.12,FIELD_H,-FIELD_W/2,0); addLine(0.12,FIELD_H,FIELD_W/2,0);
addLine(0.12,FIELD_H,0,0);

/* الكرة */
const ball = new THREE.Mesh(new THREE.SphereGeometry(0.6,32,32), new THREE.MeshStandardMaterial({color:0xffffff}));
ball.castShadow = true; ball.position.set(0,0.6,0); scene.add(ball);
const ballShadow = new THREE.Mesh(new THREE.CircleGeometry(0.75,32), new THREE.MeshBasicMaterial({color:0x000000, transparent:true, opacity:0.35}));
ballShadow.rotation.x = -Math.PI/2; ballShadow.position.y = 0.01; scene.add(ballShadow);

/* المرمى (مبسط) */
function createGoal(z){
  const g = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({color:0xdddddd});
  const cross = new THREE.Mesh(new THREE.BoxGeometry(8,0.2,0.2), mat);
  cross.position.set(0,4,z);
  g.add(cross);
  const l = new THREE.Mesh(new THREE.BoxGeometry(0.2,4,0.2), mat); l.position.set(-4,2,z); g.add(l);
  const r = l.clone(); r.position.x = 4; g.add(r);
  scene.add(g);
}
createGoal(-FIELD_H/2 - 1); createGoal(FIELD_H/2 + 1);

/* حارس مرمى */
const goalie = new THREE.Mesh(new THREE.BoxGeometry(1,3,1), new THREE.MeshStandardMaterial({color:0xff4444}));
goalie.castShadow = true; goalie.position.set(0,1.5,-FIELD_H/2-1.5); scene.add(goalie);

/* جمهور مبسط */
const crowd = new THREE.Group();
for(let i=0;i<60;i++){
  const fan = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.8,0.6), new THREE.MeshStandardMaterial({color: Math.random()>0.5?0xffcc00:0x1e90ff}));
  fan.position.set((Math.random()-0.5)*FIELD_W*1.6,1, Math.random()>0.5 ? FIELD_H/2+3 : -FIELD_H/2-3);
  crowd.add(fan);
}
scene.add(crowd);

/* الأصوات (روابط عامة) */
const kickSound = new Audio('https://actions.google.com/sounds/v1/impacts/wood_plank_flicks.ogg');
const goalSound = new Audio('https://actions.google.com/sounds/v1/crowds/goal_cheer.ogg');
const whistle = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

/* قواعد اللعب — بيانات تجريبية للفرق واللاعبين */
const teamsData = {
  spanish:['Real Madrid','Barcelona','Atletico Madrid'],
  english:['Manchester United','Liverpool','Chelsea'],
  german:['Bayern Munich','Dortmund','Leverkusen'],
  french:['PSG','Lyon','Marseille'],
  italian:['Juventus','Milan','Inter'],
  ucl:['Real Madrid','Liverpool','Bayern Munich','PSG'],
  africa:['Egypt','Cameroon','Nigeria'],
  euro:['France','Germany','Italy'],
  world:['Brazil','Argentina','Germany']
};
const playersSample = [
  {name:'Player1',number:1,role:'GK'},{name:'Player2',number:2,role:'DF'},{name:'Player3',number:3,role:'DF'},{name:'Player4',number:4,role:'DF'},
  {name:'Player5',number:5,role:'MF'},{name:'Player6',number:6,role:'MF'},{name:'Player7',number:7,role:'MF'},{name:'Player8',number:8,role:'FW'},
  {name:'Player9',number:9,role:'FW'},{name:'Player10',number:10,role:'FW'},{name:'Player11',number:11,role:'DF'}
];

/* UI elements */
const menu = document.getElementById('menu');
const nextToTeams = document.getElementById('nextToTeams');
const teamSelection = document.getElementById('teamSelection');
const teamSelect = document.getElementById('teamSelect');
const confirmTeam = document.getElementById('confirmTeam');
const formationPanel = document.getElementById('formationPanel');
const playersContainer = document.getElementById('playersContainer');
const confirmFormation = document.getElementById('confirmFormation');
const settingsPanel = document.getElementById('settingsPanel');
const startGameBtn = document.getElementById('startGameBtn');
const pausePanel = document.getElementById('pausePanel');
const resumeBtn = document.getElementById('resumeBtn');
const cameraBtn = document.getElementById('cameraBtn');
const editFormBtn = document.getElementById('editFormBtn');
const exitBtn = document.getElementById('exitBtn');
const messages = document.getElementById('messages');
const scoreAEl = document.getElementById('scoreA');
const scoreBEl = document.getElementById('scoreB');
const matchTimeEl = document.getElementById('matchTime');
const mobileControls = document.getElementById('mobileControls');
const jumpBtn = document.getElementById('jumpBtn');

let selectedCompetition = 'friendly';
let selectedTeam = '';
let teamPlayers = [...playersSample];
let substitutionsLeft = 5;
let gamePaused = false;

/* تهيئة القوائم */
nextToTeams.onclick = ()=> {
  selectedCompetition = document.getElementById('competitionSelect').value;
  teamSelect.innerHTML = '';
  (teamsData[selectedCompetition]||[]).forEach(t=>{
    const opt = document.createElement('option'); opt.value=t; opt.textContent=t; teamSelect.appendChild(opt);
  });
  menu.style.display='none'; teamSelection.style.display='block';
};
confirmTeam.onclick = ()=> {
  selectedTeam = teamSelect.value || (teamsData[selectedCompetition]||[])[0] || 'Team';
  teamSelection.style.display='none'; renderFormation(); formationPanel.style.display='block';
};
function renderFormation(){
  playersContainer.innerHTML='';
  teamPlayers.forEach((p,idx)=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px';
    const label = document.createElement('div'); label.textContent = `${p.number} — ${p.name} (${p.role})`;
    const swapBtn = document.createElement('button'); swapBtn.textContent='استبدال';
    swapBtn.onclick = ()=> {
      if(substitutionsLeft<=0){ showMessage('No substitutions left'); return; }
      const newName = prompt('اسم لاعب الاحتياط:','NewPlayer');
      const newNum = parseInt(prompt('رقم اللاعب:', 99));
      if(newName && newNum){ teamPlayers[idx] = {name:newName, number:newNum, role:p.role}; substitutionsLeft--; renderFormation(); }
    };
    row.appendChild(label); row.appendChild(swapBtn); playersContainer.appendChild(row);
  });
}

/* تأكيد التشكيلة والانتقال لصفحة الإعدادات */
confirmFormation.onclick = ()=> { formationPanel.style.display='none'; settingsPanel.style.display='block'; };

/* بدء المباراة - تهيئة الوقت وبعض القيم */
let matchDuration = 30; // دقائق
let extraTime = 0;
let currentSeconds = 0;
let running = false;
startGameBtn.onclick = ()=> {
  matchDuration = parseInt(document.getElementById('durationSelect').value);
  extraTime = parseInt(document.getElementById('extraSelect').value);
  settingsPanel.style.display='none';
  running = true;
  showMessage('المباراة بدأت!');
  whistle.play().catch(()=>{});
};

/* رسائل مؤقتة على الشاشة */
function showMessage(text, duration=2500){
  messages.style.display='block'; messages.textContent=text;
  setTimeout(()=>{ messages.style.display='none'; }, duration);
}

/* فيزياء مبسطة للكرة */
let ballVel = new THREE.Vector3(ballVelocity.x, 0, ballVelocity.z);
let gravity = -20;
let onGround = true;

/* فحص الأهداف، الركنيات ورميات التماس حسب خروج الكرة */
function checkOutOfBounds(){
  // حدود X و Z
  if(ball.position.x < -FIELD_W/2 || ball.position.x > FIELD_W/2){
    // جانب جانبي => رمية تماس (throw-in)
    showMessage('رمية تماس للخصم');
    resetAfterSetPiece('throw');
    return true;
  }
  if(ball.position.z < -FIELD_H/2 - 0.5){
    // خرج من خلف مرمى A => ركنية للخصم
    showMessage('ركلة ركنية للخصم');
    resetAfterSetPiece('corner');
    return true;
  }
  if(ball.position.z > FIELD_H/2 + 0.5){
    showMessage('ركلة ركنية للخصم');
    resetAfterSetPiece('corner');
    return true;
  }
  return false;
}

/* إعادة الكرة بعد ركلة ثابتة (تبسيط) */
function resetAfterSetPiece(type){
  // تأخير قصير ثم إعادة للوسط
  running = false;
  setTimeout(()=>{
    ball.position.set(0,0.6,0);
    ballVel.set(0.06,0,0.03);
    running = true;
  }, 1200);
}

/* نظام المخالفات والبطاقات */
function foulAt(position, severity){
  // severity: 1=تحذير شفهي، 2=صفراء، 3=حمراء
  if(severity===1){ showMessage('انذار شفهي من الحكم'); whistle.play().catch(()=>{}); }
  if(severity===2){ showMessage('بطاقة صفراء'); displayCard('yellow'); whistle.play().catch(()=>{}); }
  if(severity===3){ showMessage('بطاقة حمراء'); displayCard('red'); whistle.play().catch(()=>{}); }
}

/* عرض بطاقة */
function displayCard(type){
  const el = document.createElement('div'); el.className='card'; el.textContent = type==='yellow' ? 'بطاقة صفراء' : 'بطاقة حمراء';
  document.getElementById('topHud').appendChild(el);
  setTimeout(()=> el.remove(), 3000);
}

/* تسجيل هدف */
let scoreA = 0, scoreB = 0;
function scoreGoal(side){
  if(side==='A'){ scoreA++; scoreAEl.textContent = scoreA; } else { scoreB++; scoreBEl.textContent = scoreB; }
  goalSound.play().catch(()=>{});
  showMessage('هدف!'); resetAfterSetPiece('goal');
}

/* تبسيط: تحقق إذا دخل الهدف عبر خط المرمى */
function checkGoal(){
  // إذا زادت Z عن الحافة
  if(ball.position.z < -FIELD_H/2 - 0.9){
    scoreGoal('B'); return true;
  }
  if(ball.position.z > FIELD_H/2 + 0.9){
    scoreGoal('A'); return true;
  }
  return false;
}

/* تحريك الحارس وتصادم مع الكرة */
function moveGoalie(dt){
  goalie.position.x += goalieDir * dt * 3;
  if(goalie.position.x > 6 || goalie.position.x < -6) goalieDir *= -1;
  // اصطدام مبسط: إذا قربت الكرة من الحارس فسددها بعيداً
  const dx = Math.abs(ball.position.x - goalie.position.x);
  const dz = Math.abs(ball.position.z - goalie.position.z);
  if(dx < 1.0 && dz < 1.5 && ball.position.y < 1.2){
    ballVel.z = 6 * (ball.position.z > 0 ? 1 : -1);
    ballVel.x = (ball.position.x - goalie.position.x)*1.5;
    kickSound.play().catch(()=>{});
  }
}

/* الوقت الرئيسي للمباراة (من 0:00 إلى مدة المباراة + وقت إضافي) */
function updateMatchTime(dt){
  if(!running) return;
  currentSeconds += dt;
  const totalSeconds = Math.floor(currentSeconds);
  const minutes = Math.floor(totalSeconds/60);
  const seconds = totalSeconds%60;
  matchTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2,'0')}`;
  // نهاية الشوط/المباراة: إذا تجاوزنا المدة المحددة + extra
  const matchTotal = (matchDuration + extraTime) * 60;
  if(totalSeconds >= matchTotal){
    running = false; showMessage('انتهت المباراة'); whistle.play().catch(()=>{});
  }
}

/* إظهار/إخفاء لوحة الموبايل تلقائياً */
function detectMobile(){ return /Mobi|Android/i.test(navigator.userAgent); }
if(detectMobile()){
  mobileControls.style.display='flex';
  jumpBtn.style.display='block';
}

/* تحكمات اللاعبين الأساسية (لوحة مفاتيح + أزرار موبايل) */
const keys = new Set();
window.addEventListener('keydown', e=>{ keys.add(e.key.toLowerCase()); if([' ','arrowup','arrowdown','arrowleft','arrowright'].includes(e.key.toLowerCase())) e.preventDefault(); if(e.key==='Escape'){ gamePaused=true; pausePanel.style.display='block'; }});
window.addEventListener('keyup', e=>{ keys.delete(e.key.toLowerCase()); });

document.querySelectorAll('.mbtn').forEach(b=>{
  b.addEventListener('touchstart', ()=> keys.add(b.dataset.key));
  b.addEventListener('touchend', ()=> keys.delete(b.dataset.key));
});
jumpBtn.addEventListener('touchstart', ()=> keys.add(' '));
jumpBtn.addEventListener('touchend', ()=> keys.delete(' '));

/* حلقة الأنيميشن الرئيسية */
let prev = performance.now();
function loop(now){
  requestAnimationFrame(loop);
  const dt = Math.min((now - prev)/1000, 0.05); prev = now;
  if(running && !gamePaused){
    // تحديث الفيزياء للكرة
    ballVel.y += gravity * dt;
    ball.position.add(ballVel.clone().multiplyScalar(dt));
    if(ball.position.y <= 0.6){ ball.position.y = 0.6; ballVel.y = 0; onGround = true; }
    // ارتدادات حدود الملعب
    if(ball.position.x < -FIELD_W/2 + 0.6){ ball.position.x = -FIELD_W/2 + 0.6; ballVel.x *= -0.7; }
    if(ball.position.x > FIELD_W/2 - 0.6){ ball.position.x = FIELD_W/2 - 0.6; ballVel.x *= -0.7; }
    if(ball.position.z < -FIELD_H/2 + 0.6){ ball.position.z = -FIELD_H/2 + 0.6; ballVel.z *= -0.7; }
    if(ball.position.z > FIELD_H/2 - 0.6){ ball.position.z = FIELD_H/2 - 0.6; ballVel.z *= -0.7; }

    // ظل الكرة
    ballShadow.position.set(ball.position.x,0.01,ball.position.z);
    ballShadow.material.opacity = Math.max(0.15, 0.6 - (ball.position.y-0.6)*0.1);

    // حركة الحارس
    moveGoalie(dt);

    // تحقق الأهداف والحدود
    if(checkGoal()){} else { checkOutOfBounds(); }

    // تحديث الوقت
    updateMatchTime(dt);

    // تفاعل اللاعب: دفع الكرة بمحاكاة (اتجاه أمامي مع WASD)
    let ax = 0, az = 0;
    if(keys.has('arrowup') || keys.has('w')) az -= 1;
    if(keys.has('arrowdown') || keys.has('s')) az += 1;
    if(keys.has('arrowleft') || keys.has('a')) ax -= 1;
    if(keys.has('arrowright') || keys.has('d')) ax += 1;
    if(ax!==0 || az!==0){
      // دفعة إلى الكرة إن كانت قريبة للأصل (تبسيط: تدفع الكرة إذا المقطع قريب من المركز)
      const dist = Math.hypot(ball.position.x, ball.position.z);
      if(dist < 8){
        ballVel.x += ax * 5 * dt;
        ballVel.z += az * 5 * dt;
        kickSound.play().catch(()=>{});
      }
    }
  }

  // تحديث HUD والـ renderer
  renderer.render(scene, camera);
}
requestAnimationFrame(loop);

/* مساعدة: إظهار رسالة صغيرة */
function showMessage(text){ messages.style.display='block'; messages.textContent = text; setTimeout(()=> messages.style.display='none', 2200); }

/* أحداث لوحة التحكم */
resumeBtn.onclick = ()=> { gamePaused = false; pausePanel.style.display='none'; showMessage('استئناف'); };
cameraBtn.onclick = ()=> { alert('إعدادات الكاميرا: يمكنك تدوير/تقريب الكاميرا بالماوس.'); };
editFormBtn.onclick = ()=> { pausePanel.style.display='none'; formationPanel.style.display='block'; };
exitBtn.onclick = ()=> { if(confirm('هل تريد الخروج من اللعبة؟')) location.reload(); };

/* بدء الواجهة */ 
menu.style.display='block';
</script>
</body>
</html>
